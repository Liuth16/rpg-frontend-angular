<main class="play-layout">
  <!-- Right side: Chat + Combat -->
  <div class="right-panel flex flex-col gap-4">
    <!-- Chat -->
    @if (selectedCampaign()) {
    <section class="chat-panel details-background flex flex-col">
      <header class="panel-header">
        <h2 class="text-lg font-bold">Chat</h2>
      </header>
      <div class="chat-log flex-1 overflow-y-auto p-4 flex flex-col gap-4" #chatContainer>
        @for (turn of turns(); track turn.id) {
        <div class="p-2 border-b border-gray-700">
          <div class="text-blue-600 mb-1 font-sans">
            <strong>Você:</strong> {{ turn.user_input }}
          </div>
          <div class="text-black mb-1 font-sans">
            <strong>Narrativa:</strong> {{ turn.narrative }}
          </div>

          <!-- Effects -->
          @if (turnEffects(turn).length > 0) {
          <div class="ml-4 mt-1 text-sm text-red-600 font-sans">
            @for (eff of turnEffects(turn); track $index) {
            <div>⚔️ {{ eff }}</div>
            }
          </div>
          }

          <!-- Rewards -->
          @if (turnRewards(turn).length > 0) {
          <div class="ml-4 mt-1 text-sm text-yellow-600 font-sans">
            @for (reward of turnRewards(turn); track $index) {
            <div>{{ reward }}</div>
            }
          </div>
          }

          <!-- Suggested Actions -->
          @if (turn.suggested_actions?.length > 0) {
          <div class="ml-4 mt-2 flex flex-wrap gap-2">
            @for (sa of turn.suggested_actions; track $index) {
            <button pButton type="button" class="blz-button" (click)="useSuggestedAction(sa)">
              {{ sa }}
            </button>
            }
          </div>
          }
        </div>
        }
      </div>
      <!-- Input bar (always visible below right side) -->
      <div class="chat-input flex gap-2 p-4">
        <input
          pInputText
          [(ngModel)]="actionInput"
          placeholder="Escreva sua ação..."
          class="flex-1"
          (keyup.enter)="sendAction()"
        />
        <button pButton label="Enviar" class="blz-button" (click)="sendAction()"></button>
      </div>
    </section>
    }

    <!-- Combat -->
    @if (currentCombat()) {
    <section class="combat-panel details-background flex flex-col flex-grow">
      <header class="panel-header">
        <h2 class="text-lg font-bold">Combate</h2>
      </header>

      <!-- Duel layout -->
      <div class="p-4 flex flex-col gap-4 flex-grow overflow-y-auto">
        <div class="flex items-center justify-between gap-6 combat-panel">
          <!-- Player card -->
          <div class="flex-1 min-w-[120px] p-4 rounded-md">
            <h3 class="font-semibold mb-2 text-emerald-400">Jogador</h3>

            <!-- Health -->
            <div class="text-sm">
              <div class="flex items-center justify-between">
                <span class="font-medium">Vida</span>
                <span>
                  {{ currentCombat().player.health }} / {{ currentCombat().player.max_health }}
                </span>
              </div>
              <div class="h-2 bg-black/40 rounded mt-1 overflow-hidden">
                <div
                  class="h-full bg-emerald-500"
                  [style.width.%]="
                    (currentCombat().player.health / currentCombat().player.max_health) * 100
                  "
                ></div>
              </div>
            </div>

            <!-- Attributes -->
            <div class="grid grid-cols-4 gap-2 mt-3 text-xs">
              <div class="rounded bg-white/5 p-2 text-center">
                <div class="font-semibold">FOR</div>
                <div>{{ currentCombat().player.attributes.strength }}</div>
              </div>
              <div class="rounded bg-white/5 p-2 text-center">
                <div class="font-semibold">DES</div>
                <div>{{ currentCombat().player.attributes.dexterity }}</div>
              </div>
              <div class="rounded bg-white/5 p-2 text-center">
                <div class="font-semibold">INT</div>
                <div>{{ currentCombat().player.attributes.intelligence }}</div>
              </div>
              <div class="rounded bg-white/5 p-2 text-center">
                <div class="font-semibold">CAR</div>
                <div>{{ currentCombat().enemy.attributes.charisma }}</div>
              </div>
            </div>
          </div>

          <!-- Swords divider -->
          <div class="swords-divider mx-2"></div>

          <!-- Enemy card -->
          <div class="flex-1 min-w-[120px] p-4 rounded-md">
            <h3 class="font-semibold mb-2 text-rose-400">Inimigo</h3>

            <!-- Health -->
            <div class="text-sm">
              <div class="flex items-center justify-between">
                <span class="font-medium">Vida</span>
                <span>
                  {{ currentCombat().enemy.health }} / {{ currentCombat().enemy.max_health }}
                </span>
              </div>
              <div class="h-2 bg-black/40 rounded mt-1 overflow-hidden">
                <div
                  class="h-full bg-rose-500"
                  [style.width.%]="
                    (currentCombat().enemy.health / currentCombat().enemy.max_health) * 100
                  "
                ></div>
              </div>
            </div>

            <!-- Attributes -->
            <div class="grid grid-cols-4 gap-2 mt-3 text-xs">
              <div class="rounded bg-white/5 p-2 text-center">
                <div class="font-semibold">FOR</div>
                <div>{{ currentCombat().enemy.attributes.strength }}</div>
              </div>
              <div class="rounded bg-white/5 p-2 text-center">
                <div class="font-semibold">DES</div>
                <div>{{ currentCombat().enemy.attributes.dexterity }}</div>
              </div>
              <div class="rounded bg-white/5 p-2 text-center">
                <div class="font-semibold">INT</div>
                <div>{{ currentCombat().enemy.attributes.intelligence }}</div>
              </div>
              <div class="rounded bg-white/5 p-2 text-center">
                <div class="font-semibold">CAR</div>
                <div>{{ currentCombat().enemy.attributes.charisma }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Effects as chips (optional but tidy) -->
        @if (currentCombat()?.effects?.length > 0) {
        <div class="mt-2">
          <h4 class="font-medium mb-2">Efeitos</h4>
          <div class="flex flex-wrap gap-2">
            @for (eff of currentCombat().effects; track $index) {
            <span class="px-2 py-1 text-xs rounded bg-white/5 border border-white/10">
              {{ eff.type }} → {{ eff.target }} {{ eff.value ? '(' + eff.value + ')' : '' }}
            </span>
            }
          </div>
        </div>
        }
      </div>
    </section>
    }
  </div>
</main>

<p-confirmDialog></p-confirmDialog>
