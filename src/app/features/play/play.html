<main class="play-layout">
  <!-- Right side: Chat + Combat -->
  <div class="right-panel">
    <!-- Chat -->
    @if (selectedCampaign()) {
    <section class="chat-panel details-background">
      <header class="panel-header">
        <h2 class="text-lg font-bold">Chat</h2>
      </header>
      <div class="chat-log" #chatContainer>
        @for (turn of turns(); track turn.id) {
        <div class="turn-entry">
          <div class="user-message"><strong>Você:</strong> {{ turn.user_input }}</div>
          <div class="narrative-message"><strong>Narrativa:</strong> {{ turn.narrative }}</div>

          <!-- Effects -->
          @if (turnEffects(turn).length > 0) {
          <div class="effects-list">
            @for (eff of turnEffects(turn); track $index) {
            <div class="effect-item">⚔️ {{ eff }}</div>
            }
          </div>
          }

          <!-- Rewards -->
          @if (turnRewards(turn).length > 0) {
          <div class="rewards-list">
            @for (reward of turnRewards(turn); track $index) {
            <div class="reward-item">{{ reward }}</div>
            }
          </div>
          }

          <!-- Suggested Actions -->
          @if (turn.suggested_actions?.length > 0) {
          <div class="suggested-actions">
            @for (sa of turn.suggested_actions; track $index) {
            <button pButton type="button" class="action-button" (click)="useSuggestedAction(sa)">
              {{ sa }}
            </button>
            }
          </div>
          }
        </div>
        }
      </div>

      <!-- Input bar (always visible below chat) -->
      <div class="chat-input">
        <input
          pInputText
          [(ngModel)]="actionInput"
          placeholder="Escreva sua ação..."
          class="input-field"
          (keyup.enter)="sendAction()"
        />
        <button pButton label="Enviar" class="send-button" (click)="sendAction()"></button>
      </div>
    </section>
    }

    <!-- Combat (appears below chat when active) -->
    @if (currentCombat()) {
    <section class="combat-panel details-background">
      <header class="panel-header">
        <h2 class="text-lg font-bold">Combate</h2>
      </header>

      <!-- Duel layout -->
      <div class="combat-content">
        <div class="duel-container">
          <!-- Player card -->
          <div class="combatant-card player-card">
            <h3 class="combatant-name player-name">Jogador</h3>

            <!-- Health -->
            <div class="health-section">
              <div class="health-text">
                <span class="label">Vida</span>
                <span class="value">
                  {{ currentCombat().player.health }} / {{ currentCombat().player.max_health }}
                </span>
              </div>
              <div class="health-bar-container">
                <div
                  class="health-bar player-health"
                  [style.width.%]="
                    (currentCombat().player.health / currentCombat().player.max_health) * 100
                  "
                ></div>
              </div>
            </div>

            <!-- Attributes -->
            <div class="attributes-grid">
              <div class="attribute-box">
                <div class="attr-label">FOR</div>
                <div class="attr-value">{{ currentCombat().player.attributes.strength }}</div>
              </div>
              <div class="attribute-box">
                <div class="attr-label">DES</div>
                <div class="attr-value">{{ currentCombat().player.attributes.dexterity }}</div>
              </div>
              <div class="attribute-box">
                <div class="attr-label">INT</div>
                <div class="attr-value">{{ currentCombat().player.attributes.intelligence }}</div>
              </div>
              <div class="attribute-box">
                <div class="attr-label">CAR</div>
                <div class="attr-value">{{ currentCombat().player.attributes.charisma }}</div>
              </div>
            </div>
          </div>

          <!-- Swords divider -->
          <div class="swords-divider"></div>

          <!-- Enemy card -->
          <div class="combatant-card enemy-card">
            <h3 class="combatant-name enemy-name">Inimigo</h3>

            <!-- Health -->
            <div class="health-section">
              <div class="health-text">
                <span class="label">Vida</span>
                <span class="value">
                  {{ currentCombat().enemy.health }} / {{ currentCombat().enemy.max_health }}
                </span>
              </div>
              <div class="health-bar-container">
                <div
                  class="health-bar enemy-health"
                  [style.width.%]="
                    (currentCombat().enemy.health / currentCombat().enemy.max_health) * 100
                  "
                ></div>
              </div>
            </div>

            <!-- Attributes -->
            <div class="attributes-grid">
              <div class="attribute-box">
                <div class="attr-label">FOR</div>
                <div class="attr-value">{{ currentCombat().enemy.attributes.strength }}</div>
              </div>
              <div class="attribute-box">
                <div class="attr-label">DES</div>
                <div class="attr-value">{{ currentCombat().enemy.attributes.dexterity }}</div>
              </div>
              <div class="attribute-box">
                <div class="attr-label">INT</div>
                <div class="attr-value">{{ currentCombat().enemy.attributes.intelligence }}</div>
              </div>
              <div class="attribute-box">
                <div class="attr-label">CAR</div>
                <div class="attr-value">{{ currentCombat().enemy.attributes.charisma }}</div>
              </div>
            </div>
          </div>
        </div>

        <!-- Effects as chips -->
        @if (currentCombat()?.effects?.length > 0) {
        <div class="combat-effects">
          <h4 class="effects-title">Efeitos</h4>
          <div class="effects-chips">
            @for (eff of currentCombat().effects; track $index) {
            <span class="effect-chip">
              {{ eff.type }} → {{ eff.target }} {{ eff.value ? '(' + eff.value + ')' : '' }}
            </span>
            }
          </div>
        </div>
        }
      </div>
    </section>
    }
  </div>
</main>

<p-confirmDialog></p-confirmDialog>
